<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - DentalDesign.Dashboard</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/DentalDesign.Dashboard.styles.css" asp-append-version="true" />
</head>
<body>
    <header>
        @await Component.InvokeAsync("Navbar")
    </header>
    <div class="d-flex">
        @await Component.InvokeAsync("Sidebar")


        <div id="mainContent" class="flex-grow-1 p-3">
            
                @RenderBody()
        </div>
    </div>
    
    @await Html.PartialAsync("_DeleteConfirmModal")

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - DentalDesign.Dashboard - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)


    <script>
        // ✅ Global variables
        let mainContent;

        /**
         * Loads a page via AJAX and injects it into #mainContent.
         * param {string} url - The URL to load
         * param {boolean} pushState - Whether to update browser history
         */
        function loadPage(url, pushState = true) {
            const searchInput = document.getElementById("searchInput");
            const searchValue = searchInput ? searchInput.value : '';
            const wasFocused = searchInput === document.activeElement;
            fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.text();
                })
                .then(html => {
                    mainContent.innerHTML = html;

                    // ✅ استعد قيمة البحث والتركيز
            const newSearchInput = document.getElementById("searchInput");
            if (newSearchInput) {
                newSearchInput.value = searchValue;
                if (wasFocused) {
                    newSearchInput.focus();
                    // اختياري: ضع المؤشر في النهاية
                    newSearchInput.setSelectionRange(searchValue.length, searchValue.length);
                }
            }

                    // Update sidebar active state
                    const pathname = new URL(url, window.location.origin).pathname;
                    document.querySelectorAll(".sidebar-wrapper li").forEach(li => li.classList.remove("active"));
                    const activeLink = document.querySelector(`.sidebar-wrapper a[href^='${pathname}']`);
                    if (activeLink) activeLink.parentElement.classList.add("active");

                    if (pushState) {
                        history.pushState({ url: url }, "", url);
                    }

                    // Re-bind all dynamic handlers
                    bindDynamicEventHandlers();
                })
                .catch(err => {
                    console.error("Failed to load page:", err);
                    alert("Failed to load page. Please try again.");
                });
        }

        /**
         * Binds event handlers to dynamically loaded content
         */
        function bindDynamicEventHandlers() {
            // === 1. AJAX Links (Create, Edit, Details, etc.) ===
            document.querySelectorAll(".ajax-link").forEach(link => {
                if (!link.dataset.bound) {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();
                        loadPage(this.href);
                    });
                    link.dataset.bound = "true";
                }
            });

            // === 2. Live Search (on input) ===
            const searchInput = document.getElementById("searchInput");
            if (searchInput && !searchInput.dataset.bound) {
                let searchTimeout;
                searchInput.addEventListener("input", function () {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    const pathParts = window.location.pathname.split('/').filter(p => p);
                    const controller = pathParts[0] || 'Home';
                    const url = `/${controller}/Index?Name=${encodeURIComponent(query)}`;

                    searchTimeout = setTimeout(() => {
                        loadPage(url);
                    }, 300);
                });
                searchInput.dataset.bound = "true";
            }

            // === 3. Pagination ===
            document.querySelectorAll(".pagination .page-link").forEach(link => {
                if (!link.dataset.bound) {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();
                        loadPage(this.href);
                    });
                    link.dataset.bound = "true";
                }
            });

            // === 4. Edit Forms (POST) ===
            document.querySelectorAll('form[id^="edit"][method="post"]').forEach(form => {
                if (!form.dataset.bound) {
                    form.addEventListener("submit", function (e) {
                        e.preventDefault();

                        const formData = new FormData(this);
                        const url = this.action;
                        const tokenInput = this.querySelector('input[name="__RequestVerificationToken"]');
                        if (tokenInput) {
                            formData.set("__RequestVerificationToken", tokenInput.value);
                        }

                        fetch(url, {
                            method: "POST",
                            headers: { "X-Requested-With": "XMLHttpRequest" },
                            body: formData
                        })
                        .then(async res => {
                            if (res.ok) {
                                const contentType = res.headers.get("content-type");
                                if (contentType?.includes("application/json")) {
                                    const result = await res.json();
                                    if (result?.isSuccess) {
                                        const urlParts = new URL(url, window.location.origin).pathname.split('/').filter(p => p);
                                        const controller = urlParts[0] || 'Home';
                                        loadPage(`/${controller}/Index`);
                                    } else {
                                        throw new Error("Unexpected JSON response");
                                    }
                                } else {
                                    // Handle validation errors (HTML response)
                                    const html = await res.text();
                                    mainContent.innerHTML = html;
                                    bindDynamicEventHandlers();
                                }
                            } else {
                                const html = await res.text();
                                mainContent.innerHTML = html;
                                bindDynamicEventHandlers();
                            }
                        })
                        .catch(err => {
                            console.error("Edit failed:", err);
                            alert("Failed to save changes.");
                        });
                    });
                    form.dataset.bound = "true";
                }
            });
        }

        // ✅ Delete Modal Functions
        function openDeleteSingle(id, config = {}) {
            const endpoint = config.endpoint || '';
            const title = config.title || 'Delete Item';
            const message = config.message || 'Are you sure you want to delete this item?';

            document.getElementById('deleteIds').value = id;
            document.getElementById('deleteFormModal').action = endpoint;
            document.getElementById('deleteTitle').innerText = title;
            document.getElementById('deleteMessage').innerHTML = `
                <p class="mb-2">${message}</p>
                <p class="text-muted small">This action cannot be undone.</p>
            `;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        function openDeleteSelected(config = {}) {
            const endpoint = config.endpoint || '';
            const title = config.title || 'Delete Selected Items';
            const messagePrefix = config.messagePrefix || 'items';

            const selected = [...document.querySelectorAll('input[name="selectedIds"]:checked')].map(c => c.value);
            if (selected.length === 0) {
                alert('No items selected.');
                return;
            }

            document.getElementById('deleteIds').value = selected.join(',');
            document.getElementById('deleteFormModal').action = endpoint;
            document.getElementById('deleteTitle').innerText = title;
            document.getElementById('deleteMessage').innerHTML = `
                <p class="mb-2">Are you sure you want to delete <strong>${selected.length}</strong> ${messagePrefix}?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            `;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        function submitGlobalDelete(event) {
            event.preventDefault();
            const form = document.getElementById('deleteFormModal');
            const url = form.action;
            const ids = document.getElementById('deleteIds').value;
            const modalElement = document.getElementById('deleteConfirmModal');
            const modal = bootstrap.Modal.getInstance(modalElement);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `ids=${encodeURIComponent(ids)}`
            })
            .then(async res => {
                if (res.ok) {
                    if (modal) modal.hide();
                    loadPage(location.href, false);
                } else {
                    const errorMessage = await res.text().catch(() => 'Unknown error');
                    throw new Error(errorMessage || 'Delete operation failed');
                }
            })
            .catch(err => {
                console.error("Delete failed:", err);
                alert(err.message || "An error occurred during deletion.");
            });
        }

        // ✅ Initialize on DOM ready
        document.addEventListener("DOMContentLoaded", function () {
            mainContent = document.getElementById("mainContent");

            // Sidebar navigation
            document.querySelectorAll(".sidebar-wrapper a").forEach(a => {
                a.addEventListener("click", function (e) {
                    e.preventDefault();
                    loadPage(this.href);
                });
            });

            // Browser back/forward navigation
            window.addEventListener("popstate", function () {
                loadPage(location.href, false);
            });

            // Initial binding for content loaded on first page load
            bindDynamicEventHandlers();
        });
    </script>

</body>
</html>
